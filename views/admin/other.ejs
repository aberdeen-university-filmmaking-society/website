<%- include header.ejs %>
<style>
table {
  border-collapse: collapse;
  font-family: Consolas, 'Courier New', Courier, monospace;
  width:100%;
}

table, th, td {
  border: 1px solid black;
}
.table-cmds{
    width:64px;
}
.tageditor{
    display: flex;
}
.tageditor-listcontainer{
    width:300px;
    height:256px;
}
.tageditor-listcontainer{
    padding:0;
}
.tageditor-editor{
    width:100%;
    height:100%;
    background-color:blue;
}

</style>
<div class="section">
        <div class="sectionheader">Topics</div>
        <p>Any tag can be given a full name and an optional description, transforming it into a "topic". Topics exist even if no post or film is tagged with one, and are given more importance when calculating related films/posts</p>
        <input id='tags' type="text" placeholder='Search tags...' onkeyup="searchedTag()" style="width:calc(100% - 152px);display:inline-block;">
        <script>
            var availabletags = [];
            <% if(tags) { %>
                availabletags = JSON.parse(`<%- tags %>`)
            <% } %>
            $( "#tags" ).autocomplete({
               source: availabletags,
               autofocus:true,
               minLength:1,
               delay:0
            });
            function searchedTag(){
                var searchtext=$("#tags").val();
                if(availabletags.indexOf(searchtext)==-1){
                    $("#tageditor-button").text("CREATE TOPIC");
                }
                else{
                    $("#tageditor-button").text("EDIT TOPIC");
                }
            }
        </script>
        <button id="tageditor-button" class="smallbtn" onclick="getTopic()" style="display: inline-block;height:42px;width:148px;margin-top:0;margin-bottom:6px;">CREATE TOPIC</button>
        <div id="tageditor-container" class="hidden">
            <input id='tageditor-title' type="text" placeholder='Title' style="font-weight: bold;">
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
            <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
            <div id="tageditor-description" style="min-height: 128px"></div>
            <button class="bigbtn" onclick="cancelTopic()">CANCEL</button>
            <button class="bigbtn" onclick="saveTopic()">SAVE</button>
        </div>
    </div>
<div class="section">
        <div class="sectionheader">SQL Database</div>
        <b style="color:red;">ONLY TOUCH IF YOU KNOW WHAT YOU'RE DOING: YOU COULD PERMANENTLY REMOVE ENTRIES FROM THE DATABASE</b>
        <input id="sqlquery" type="text" style="margin-top:4px;font-family: Consolas, 'Courier New', Courier, monospace" placeholder="Query">
        <button class="smallbtn" onclick="sendsql()">SEND</button>
    </div>
    <div class="section">
            <div class="sectionheader">Committee</div>
            <input type="text" id="committeename" placeholder="Committee year" style="font-weight: bold;" value="<% if(committee && committee.name) { %><%= committee.name %><% } %>">
            <input type="text" id="ausaURL" value="<%  if(committee && committee.ausaurl) { %><%= committee.ausaurl %><% } %>" placeholder="Society page on AUSA's website">
            <button class="bigbtn" onclick="updatecommittee()">Save details &amp; sync committee with AUSA website</button>
        </div>
    <script>
    function getTopic(){
        $.get("/admin/tags/"+$("#tags").val(), function(result){
            $("#tageditor-container").removeClass("hidden");
            $("#tageditor-title").val(result.fullname);
            quill.setContents(JSON.parse(result.description));
        });
    }
    function saveTopic(){
        $.ajax({
                type: "POST",
                dataType: 'text',
                data: JSON.stringify({fullname: $("#tageditor-title").val(),description:JSON.stringify(quill.getContents()),id:$("#tags").val()}),
                contentType: 'application/json',
                url: '/admin/tags',
                success: function (res) {
                    console.log(res);
                    alert(res);
                },
                error: function(res){
                    console.log(res);
                    alert(res);
                }
            });
    }
    function cancelTopic(){
        $("#tageditor-container").addClass("hidden");
    }

    var toolbarOptions = [
    [{ 'font': [] }, { 'size': [] }],
          [ 'bold', 'italic', 'underline', 'strike' ],
          [{ 'color': [] }, { 'background': [] }],
          [{ 'script': 'super' }, { 'script': 'sub' }],
          [{ 'header': '1' }, { 'header': '2' }, 'blockquote', 'code-block' ],
          [{ 'list': 'ordered' }, { 'list': 'bullet'}, { 'indent': '-1' }, { 'indent': '+1' }],
          [ 'direction', { 'align': [] }],
          [ 'link', 'image', 'video', 'formula' ],
          [ 'clean' ]
    ];
        var quill = new Quill('#tageditor-description', {
        modules: {
            syntax: true,
            toolbar: toolbarOptions
        },
        placeholder: 'Description',
        theme: 'snow'
    });

        function sendsql(){
            $.ajax({
                type: "POST",
                dataType: 'text',
                data: JSON.stringify({query:$("#sqlquery").val()}),
                contentType: 'application/json',
                url: '/admin/sql',
                success: function (res) {
                    console.log(res);
                    alert(res);
                },
                error: function(res){
                    console.log(res);
                    alert(res);
                }
            });
        }
        function updatecommittee(){
            $.ajax({
                type: "POST",
                dataType: 'text',
                data: JSON.stringify({ausaurl:$("#ausaURL").val(), committeename:$("#committeename").val()}),
                contentType: 'application/json',
                url: '/admin/committee/update',
                success: function (res) {
                    console.log(res);
                    alert("Succesfully synced comittee list with the AUSA website!");
                },
                error: function(res){
                    console.log(res);
                    alert("Failed to sync committee list!");
                }
            });
        }
    </script>